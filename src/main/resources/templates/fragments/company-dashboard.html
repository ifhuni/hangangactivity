<!-- fragments/company-dashboard.html -->
<div th:fragment="companyDashboard">
  <section id="companyDashboardRoot"
           class="container"
           style="margin-top: 110px;"
           th:attr="data-role=${companyRole}, data-status=${companyStatus}, data-company-name=${companyName}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="fw-bold mb-0"><span th:text="${companyRole} == 'ADMIN' ? '시스템 관리자' : (${companyName} ?: '업체')"></span> 대시보드</h3>
        <div class="text-muted">안녕하세요, <span th:text="${companyUserName} ?: '담당자'">담당자</span>님</div>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadPage(event, '/fragments/home')">홈으로</button>
      </div>
    </div>

    <div id="pendingNotice" class="alert alert-warning d-none">
      업체 승인 대기 중입니다. 관리자 승인 완료 후 주요 기능을 이용할 수 있습니다.
    </div>

    <div class="row g-3 mb-4" data-role="dashboard-summary">
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">등록된 활동</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">오늘 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">진행 중 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" onclick="alert('활동 등록 화면은 추후 연동될 예정입니다.')">활동 등록</button>
        <button class="btn btn-outline-primary" onclick="alert('예약 관리 화면은 추후 연동될 예정입니다.')">예약 관리</button>
        <button class="btn btn-outline-primary" onclick="alert('정산/통계 화면은 추후 연동될 예정입니다.')">정산/통계</button>
      </div>
    </div>

    <div id="adminApprovalSection" class="card shadow-sm rounded-4 p-3" th:classappend="${#strings.equalsIgnoreCase(companyRole, 'ADMIN')} ? '' : ' d-none'">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">승인 대기 업체</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="pendingSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshPending">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">승인이 완료되면 담당자 계정으로 대시보드를 이용할 수 있습니다.</div>
      <div data-role="error" class="alert alert-danger d-none"></div>
      <div data-role="success" class="alert alert-success d-none">선택한 업체를 승인했습니다.</div>
      <div data-role="empty" class="alert alert-info d-none">승인 대기 중인 업체가 없습니다.</div>
      <div class="table-responsive d-none" data-role="table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">업체명</th>
              <th scope="col">사업자등록번호</th>
              <th scope="col">대표자</th>
              <th scope="col">담당자 정보</th>
              <th scope="col" class="text-end" data-role="action-header">승인</th>
            </tr>
          </thead>
          <tbody data-role="pending-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
  (function(){
    const root = document.getElementById('companyDashboardRoot');
    if (!root) return;

    const role = (root.dataset.role || 'COMPANY').toUpperCase();
    const status = (root.dataset.status || '').toUpperCase();
    const isAdmin = role === 'ADMIN';

    const pendingNotice = document.getElementById('pendingNotice');
    if (pendingNotice && role !== 'ADMIN' && status === 'PENDING') {
      pendingNotice.classList.remove('d-none');
    }

    initPendingSection(isAdmin);
  })();

  function initPendingSection(isAdmin){
    const section = document.getElementById('adminApprovalSection');
    if (!section) return;
    if (!isAdmin) {
      section.classList.add('d-none');
      return;
    }

    const errorEl = section.querySelector('[data-role="error"]');
    const successEl = section.querySelector('[data-role="success"]');
    const emptyEl = section.querySelector('[data-role="empty"]');
    const tableWrapper = section.querySelector('[data-role="table-wrapper"]');
    const tbody = section.querySelector('[data-role="pending-table-body"]');
    const refreshBtn = document.getElementById('btnRefreshPending');
    const spinner = document.getElementById('pendingSpinner');
    const actionHeader = section.querySelector('[data-role="action-header"]');
    const hideSuccess = () => {
      if (successEl) successEl.classList.add('d-none');
    };

    const showSuccess = (message) => {
      if (!successEl) return;
      if (typeof message === 'string' && message.trim().length > 0) {
        successEl.textContent = message;
      }
      successEl.classList.remove('d-none');
    };

    if (actionHeader) {
      if (isAdmin) {
        actionHeader.textContent = '승인';
        actionHeader.classList.add('text-end');
      } else {
        actionHeader.textContent = '상태';
        actionHeader.classList.remove('text-end');
      }
    }

    const setState = (state) => {
      hideSuccess();
      if (spinner) spinner.classList.toggle('d-none', state !== 'loading');
      if (refreshBtn) refreshBtn.disabled = state === 'loading';
      if (errorEl) errorEl.classList.toggle('d-none', state !== 'error');
      if (emptyEl) emptyEl.classList.toggle('d-none', state !== 'empty');
      if (tableWrapper) tableWrapper.classList.toggle('d-none', state !== 'table');
    };

    const escapeHtml = (value) => {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const formatDateTime = (value) => {
      if(!value) return '-';
      try {
        const date = new Date(value);
        if(Number.isNaN(date.getTime())) return '-';
        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
      } catch(_err) {
        return '-';
      }
    };

    const renderRows = (items) => {
      if (!tbody) return;
      tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.userId = String(item.userId);
        tr.dataset.companyId = String(item.companyId);

        const actionCell = isAdmin
          ? `<button class="btn btn-sm btn-success" data-action="approve">승인</button>`
          : `<span class="badge bg-warning text-dark">승인 대기</span>`;
        const actionClass = isAdmin ? 'text-end' : 'text-start';

        tr.innerHTML = `
          <td>${escapeHtml(item.companyName)}</td>
          <td>${escapeHtml(item.businessNumber || '-')}</td>
          <td>
            <div>${escapeHtml(item.ceoName || '-')}</div>
            <div class="text-muted small">${escapeHtml(item.ceoContact || '')}</div>
          </td>
          <td>
            <div>${escapeHtml(item.username || '-')}</div>
            <div class="text-muted small">등록일: ${formatDateTime(item.companyCreatedAt)}</div>
          </td>
          <td class="${actionClass}">
            ${actionCell}
          </td>`;
        tbody.appendChild(tr);
      });
    };

    const loadPending = async (force = false) => {
      const url = force ? `/api/company/pending-requests?t=${Date.now()}` : "/api/company/pending-requests";

      setState('loading');
      if (errorEl) errorEl.textContent = '';
      try {
        const res = await fetch(url, { credentials: 'same-origin', cache: 'no-store' });
        if(!res.ok){
          throw new Error('목록을 불러오지 못했습니다. (HTTP ' + res.status + ')');
        }
        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0){
          setState('empty');
          return;
        }
        renderRows(data);
        setState('table');
      } catch (err) {
        if (errorEl) {
          errorEl.textContent = err.message || '목록을 가져오는 중 오류가 발생했습니다.';
        }
        setState('error');
      }
    };

    section.classList.remove('d-none');
    loadPending();

    if (refreshBtn) {
      refreshBtn.addEventListener('click', (event) => {
        event.preventDefault();
        loadPending(true);
      });
    }

    if (isAdmin && tbody) {
      tbody.addEventListener('click', async (event) => {
        const btn = event.target.closest('button[data-action="approve"]');
        if (!btn) return;

        const row = btn.closest('tr');
        if (!row) return;

        const userId = row.dataset.userId;
        const companyId = row.dataset.companyId;
        if (!userId || !companyId) return;

        if (!confirm('해당 업체를 승인하시겠습니까?')) return;

        hideSuccess();
        const originalLabel = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>승인중';

        try {
          const res = await fetch(`/api/company/pending/${encodeURIComponent(userId)}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ companyId: Number(companyId) })
          });
          if (!res.ok) {
            throw new Error('승인 처리에 실패했습니다. (HTTP ' + res.status + ')');
          }

          const companyLabel = row.querySelector('td')?.textContent?.trim() || '선택한 업체';
          row.remove();
          if (tbody.children.length === 0) {
            setState('empty');
          }
          showSuccess(`${companyLabel} 업체를 승인했습니다.`);
        } catch (err) {
          btn.disabled = false;
          btn.innerHTML = originalLabel;
          alert(err.message);
        }
      });
    }
  }
</script>
