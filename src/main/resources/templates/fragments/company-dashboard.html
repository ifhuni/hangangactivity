<!-- fragments/company-dashboard.html -->
<div th:fragment="companyDashboard">
  <section id="companyDashboardRoot"
           class="container"
           style="margin-top: 110px;"
           th:attr="data-role=${companyRole}, data-status=${companyStatus}, data-company-name=${companyName}, data-company-id=${companyId}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="fw-bold mb-0"><span th:text="${companyRole} == 'ADMIN' ? '시스템 관리자' : (${companyName} ?: '업체')"></span> 대시보드</h3>
        <div class="text-muted">안녕하세요, <span th:text="${companyUserName} ?: '담당자'">담당자</span>님</div>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadPage(event, '/fragments/home')">홈으로</button>
      </div>
    </div>

    <div id="pendingNotice" class="alert alert-warning d-none">
      업체 승인 대기 중입니다. 관리자 승인 완료 후 주요 기능을 이용할 수 있습니다.
    </div>

    <div class="row g-3 mb-4" data-role="dashboard-summary">
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">등록된 활동</div>
          <div class="fs-4 fw-bold" id="summaryActivitiesCount">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">오늘 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">진행 중 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#activityCreateModal">활동 등록</button>
        <button class="btn btn-outline-primary" onclick="alert('정산/통계 화면은 추후 연동될 예정입니다.')">정산/통계</button>
      </div>
    </div>

    <!-- 등록된 활동 목록 (승인 대기 업체 섹션과 유사한 UI) -->
    <div id="activityListSection" class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">등록된 활동</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="activitiesSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshActivities">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">업체가 등록한 활동 목록입니다. 수정/비활성화는 추후 기능으로 연동됩니다.</div>
      <div data-role="activities-error" class="alert alert-danger d-none"></div>
      <div data-role="activities-success" class="alert alert-success d-none">요청이 정상 처리되었습니다.</div>
      <div data-role="activities-empty" class="alert alert-info d-none">등록된 활동이 없습니다.</div>
      <div class="table-responsive d-none" data-role="activities-table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">활동명</th>
              <th scope="col">카테고리</th>
              <th scope="col">위치</th>
              <th scope="col">운영일시</th>
              <th scope="col">정원(명)</th>
              <th scope="col">예약인원</th>
              <th scope="col" class="text-end">상태</th>
            </tr>
          </thead>
          <tbody data-role="activities-table-body"></tbody>
        </table>
      </div>
    </div>


    
    <div id="reservationPendingSection" class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">예약 신청 인원</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" data-role="reservations-spinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-role="reservations-refresh">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">신규 및 확정된 예약을 확인하고 관리합니다.</div>
      <div class="alert alert-danger d-none" data-role="reservations-error"></div>
      <div class="alert alert-success d-none" data-role="reservations-success">예약 상태가 업데이트되었습니다.</div>
      <div class="alert alert-info d-none" data-role="reservations-empty">예약 신청이 없습니다.</div>
      <div class="table-responsive d-none" data-role="reservations-table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">예약자</th>
              <th scope="col">활동</th>
              <th scope="col">요청 정보</th>
              <th scope="col">상태</th>
              <th scope="col" class="text-end">처리</th>
            </tr>
          </thead>
          <tbody data-role="reservations-table-body"></tbody>
        </table>
      </div>
    </div>
<div id="adminApprovalSection" class="card shadow-sm rounded-4 p-3" th:classappend="${#strings.equalsIgnoreCase(companyRole, 'ADMIN')} ? '' : ' d-none'">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">승인 대기 업체</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="pendingSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshPending">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">승인이 완료되면 담당자 계정으로 대시보드를 이용할 수 있습니다.</div>
      <div data-role="error" class="alert alert-danger d-none"></div>
      <div data-role="success" class="alert alert-success d-none">선택한 업체를 승인했습니다.</div>
      <div data-role="empty" class="alert alert-info d-none">승인 대기 중인 업체가 없습니다.</div>
      <div class="table-responsive d-none" data-role="table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">업체명</th>
              <th scope="col">사업자등록번호</th>
              <th scope="col">대표자</th>
              <th scope="col">담당자 정보</th>
              <th scope="col" class="text-end" data-role="action-header">승인</th>
            </tr>
          </thead>
          <tbody data-role="pending-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- 업체 목록 (Admin 전용) -->
    <div id="adminAllCompaniesSection" class="card shadow-sm rounded-4 p-3 mb-4" th:classappend="${#strings.equalsIgnoreCase(companyRole, 'ADMIN')} ? '' : ' d-none'">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">업체 목록</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="allCompaniesSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshAllCompanies">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">전체 업체를 관리하고 활성화/비활성화할 수 있습니다.</div>
      <div data-role="all-companies-error" class="alert alert-danger d-none"></div>
      <div data-role="all-companies-success" class="alert alert-success d-none">업체 상태가 변경되었습니다.</div>
      <div data-role="all-companies-empty" class="alert alert-info d-none">등록된 업체가 없습니다.</div>
      <div class="table-responsive d-none" data-role="all-companies-table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th scope="col">업체명</th>
            <th scope="col">사업자등록번호</th>
            <th scope="col">대표자</th>
            <th scope="col">연락처</th>
            <th scope="col" class="text-center">상태</th>
            <th scope="col" class="text-end">관리</th>
          </tr>
          </thead>
          <tbody data-role="all-companies-table-body"></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- 활동 등록 모달 -->
  <div class="modal fade" id="activityCreateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">활동 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="activityCreateForm" class="needs-validation" novalidate><input type="hidden" name="activityId" id="activityIdField">
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">활동명 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="title" required placeholder="예) 한강 일몰 카약 투어">
                <div class="invalid-feedback">활동명을 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">카테고리</label>
                <select class="form-select" name="category">
                  <option value="">선택</option>
                  <option>육상</option>
                  <option>수상</option>
                  <option>공중</option>
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">위치(만남 장소) <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="location" required placeholder="예) 뚝섬 한강공원 카약장 입구">
                <div class="invalid-feedback">위치를 입력하세요.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">정원(명)</label>
                <input type="number" class="form-control" name="capacity" min="1" placeholder="예) 12">
              </div>
              <div class="col-md-6">
                <label class="form-label">시작일시 <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" name="startAt" required>
                <div class="invalid-feedback">시작일시를 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">종료일시 <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" name="endAt" required>
                <div class="invalid-feedback">종료일시를 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">가격(원)</label>
                <input type="number" class="form-control" name="price" min="0" step="1000" placeholder="예) 35000">
              </div>
              <div class="col-md-6">
                <label class="form-label">노출 상태</label>
                <select class="form-select" name="status">
                  <option value="DRAFT">작성중</option>
                  <option value="PUBLISHED">노출</option>
                  <option value="HIDDEN">비노출</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">설명</label>
                <textarea class="form-control" name="description" rows="4" placeholder="활동 소개, 준비물, 유의사항 등을 입력"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">대표 이미지</label>
                <input type="file" class="form-control" name="image">
              </div>
            </div>
            <div class="alert alert-danger d-none mt-3" id="activityCreateError"></div>
            <div class="alert alert-success d-none mt-3" id="activityCreateSuccess">활동이 저장되었습니다.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
            <button type="submit" class="btn btn-primary" id="activityModalSubmit"><span class="spinner-border spinner-border-sm me-2 d-none" id="activityCreateSpinner" role="status" aria-hidden="true"></span><span data-role="activity-submit-label">등록</span></button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 스크립트: 활동 목록 로드 & 활동 등록 -->
      <script>
    (function () {
      const root = document.getElementById("companyDashboardRoot");
      const companyId = root?.dataset.companyId;
      const role = (root?.dataset.role || "").toUpperCase();
      const status = (root?.dataset.status || "").toUpperCase();
      const DEFAULT_STATUS = "DRAFT";

      const pendingNotice = document.getElementById("pendingNotice");
      if (pendingNotice && role !== "ADMIN" && (status === "PENDING" || status === "UNASSIGNED")) {
        pendingNotice.classList.remove("d-none");
      }

      const activityModal = document.getElementById("activityCreateModal");
      const activityForm = document.getElementById("activityCreateForm");
      const activityIdField = document.getElementById("activityIdField");
      const activityCreateSpinner = document.getElementById("activityCreateSpinner");
      const activityCreateError = document.getElementById("activityCreateError");
      const activityCreateSuccess = document.getElementById("activityCreateSuccess");
      const activityModalSubmit = document.getElementById("activityModalSubmit");
      const activitySubmitLabel = activityModalSubmit?.querySelector('[data-role="activity-submit-label"]');
      const activityModalTitle = activityModal?.querySelector(".modal-title");
      const activityImageInput = activityForm?.querySelector('input[name="image"]');
      const activityFields = activityForm ? {
        title: activityForm.elements.namedItem('title'),
        category: activityForm.elements.namedItem('category'),
        description: activityForm.elements.namedItem('description'),
        location: activityForm.elements.namedItem('location'),
        capacity: activityForm.elements.namedItem('capacity'),
        startAt: activityForm.elements.namedItem('startAt'),
        endAt: activityForm.elements.namedItem('endAt'),
        price: activityForm.elements.namedItem('price'),
        statusField: activityForm.elements.namedItem('status'),
        image: activityImageInput
      } : {};

      const btnRefreshActivities = document.getElementById("btnRefreshActivities");
      const activitiesSpinner = document.getElementById("activitiesSpinner");
      const activitiesError = document.querySelector('[data-role="activities-error"]');
      const activitiesEmpty = document.querySelector('[data-role="activities-empty"]');
      const activitiesTableWrapper = document.querySelector('[data-role="activities-table-wrapper"]');
      const activitiesTbody = document.querySelector('[data-role="activities-table-body"]');
      const summaryActivitiesCount = document.getElementById("summaryActivitiesCount");

      const reservationSection = document.getElementById("reservationPendingSection");

      function isAdmin(roleValue) {
        return roleValue === "ADMIN";
      }

      function statusBadge(s) {
        const k = String(s || "").toUpperCase();
        if (k === "PUBLISHED") return "success";
        if (k === "HIDDEN") return "secondary";
        return "warning";
      }

      function formatInterval(startAt, endAt) {
        if (!startAt && !endAt) return "";
        const s = startAt ? new Date(startAt) : null;
        const e = endAt ? new Date(endAt) : null;
        const format = (d) => Number.isNaN(d?.getTime?.()) ? "" : `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")} ${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
        return `${format(s)} ~ ${format(e)}`.trim();
      }

      function formatDateTimeValue(value) {
        if (!value) return "";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return "";
        }
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const dd = String(date.getDate()).padStart(2, "0");
        const hh = String(date.getHours()).padStart(2, "0");
        const min = String(date.getMinutes()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
      }

      function toInputDateTime(value) {
        if (!value) return "";
        const date = value instanceof Date ? value : new Date(value);
        if (Number.isNaN(date.getTime())) {
          return "";
        }
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const dd = String(date.getDate()).padStart(2, "0");
        const hh = String(date.getHours()).padStart(2, "0");
        const min = String(date.getMinutes()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
      }

      function nowInputValue() {
        return toInputDateTime(new Date());
      }

      function escapeHtml(str) {
        return String(str || "").replace(/[&<>"']/g, (m) => ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[m]));
      }

      function hideActivityMessages() {
        activityCreateError?.classList.add("d-none");
        activityCreateSuccess?.classList.add("d-none");
      }

      function setActivityModal(mode, activity) {
        if (!activityForm) {
          return;
        }
        hideActivityMessages();
        activityForm.classList.remove("was-validated");
        activityImageInput && (activityImageInput.value = "");

        if (mode === "edit") {
          activityIdField.value = activity?.id != null ? activity.id : "";
          activityFields.title && (activityFields.title.value = activity?.title || "");
          activityFields.category && (activityFields.category.value = activity?.category || "GENERAL");
          activityFields.description && (activityFields.description.value = activity?.description || "");
          activityFields.location && (activityFields.location.value = activity?.location || "");
          activityFields.capacity && (activityFields.capacity.value = activity?.capacity != null ? activity.capacity : "");
          activityFields.startAt && (activityFields.startAt.value = toInputDateTime(activity?.startAt) || nowInputValue());
          activityFields.endAt && (activityFields.endAt.value = toInputDateTime(activity?.endAt) || nowInputValue());
          activityFields.price && (activityFields.price.value = activity?.price != null ? activity.price : "");
          activityFields.statusField && (activityFields.statusField.value = (activity?.status || DEFAULT_STATUS).toUpperCase());
          activityModalTitle && (activityModalTitle.textContent = "활동 수정");
          activitySubmitLabel && (activitySubmitLabel.textContent = "수정");
          activityForm.dataset.mode = "edit";
        } else {
          activityIdField.value = "";
          activityForm.reset();
          activityFields.startAt && (activityFields.startAt.value = nowInputValue());
          activityFields.endAt && (activityFields.endAt.value = nowInputValue());
          activityFields.statusField && (activityFields.statusField.value = DEFAULT_STATUS);
          activityModalTitle && (activityModalTitle.textContent = "활동 등록");
          activitySubmitLabel && (activitySubmitLabel.textContent = "등록");
          activityForm.dataset.mode = "create";
        }
      }

      document.querySelectorAll('[data-bs-target="#activityCreateModal"]').forEach(btn => {
        btn.addEventListener("click", () => setActivityModal("create"));
      });
      setActivityModal("create");

      async function loadActivities() {
        if (!activitiesSpinner) return;
        activitiesSpinner.classList.remove("d-none");
        activitiesError?.classList.add("d-none");
        activitiesEmpty?.classList.add("d-none");
        activitiesTableWrapper?.classList.add("d-none");
        activitiesTbody && (activitiesTbody.innerHTML = "");
        try {
          const url = companyId ? `/api/companies/${companyId}/activities` : `/api/activities/mine`;
          const res = await fetch(url, { headers: { "Accept": "application/json" } });
          if (!res.ok) throw new Error("활동 목록을 불러오지 못했습니다.");
          const items = await res.json();
          if (!items || items.length === 0) {
            activitiesEmpty?.classList.remove("d-none");
            if (summaryActivitiesCount) summaryActivitiesCount.textContent = "0";
          } else {
            items.forEach(row => {
              const tr = document.createElement("tr");
              tr.dataset.activityId = row.id != null ? String(row.id) : "";
              tr.__activityData = row;
              const statusHtml = `<span class="badge bg-${statusBadge(row.status)}">${escapeHtml(row.status || "")}</span>`;
              const capacity = row.capacity != null ? String(row.capacity) : "";
              const currentParticipants = row.currentParticipants != null ? String(row.currentParticipants)
                      : (row.reservationsCount != null ? String(row.reservationsCount) : "");
              tr.innerHTML = `
              <td><button type="button" class="btn btn-link p-0" data-role="activity-edit">${escapeHtml(row.title || "")}</button></td>
              <td>${escapeHtml(row.category || "")}</td>
              <td>${escapeHtml(row.location || "")}</td>
              <td>${formatInterval(row.startAt, row.endAt)}</td>
              <td>${escapeHtml(capacity)}</td>
              <td>${escapeHtml(currentParticipants)}</td>
              <td class="text-end">${statusHtml}</td>
              `;
              activitiesTbody?.appendChild(tr);
            });
            activitiesTableWrapper?.classList.remove("d-none");
            if (summaryActivitiesCount) summaryActivitiesCount.textContent = String(items.length);
          }
        } catch (err) {
          if (activitiesError) {
            activitiesError.textContent = err.message || "오류가 발생했습니다.";
            activitiesError.classList.remove("d-none");
          }
        } finally {
          activitiesSpinner?.classList.add("d-none");
        }
      }

      btnRefreshActivities?.addEventListener("click", loadActivities);
      loadActivities();

      activitiesTbody?.addEventListener("click", async (event) => {
        const editBtn = event.target.closest('[data-role="activity-edit"]');
        if (!editBtn) {
          return;
        }
        event.preventDefault();
        const row = editBtn.closest("tr");
        const activityId = row?.dataset.activityId;
        if (!activityId) {
          return;
        }
        let activityData = row.__activityData;
        try {
          const res = await fetch(`/api/activities/${encodeURIComponent(activityId)}`, { headers: { "Accept": "application/json" } });
          if (res.ok) {
            activityData = await res.json();
            row.__activityData = activityData;
          }
        } catch (err) {
          console.warn("Failed to fetch activity detail", err);
        }
        if (!activityData) {
          return;
        }
        setActivityModal("edit", activityData);
        if (window.bootstrap?.Modal) {
          window.bootstrap.Modal.getOrCreateInstance(activityModal)?.show();
        }
      });

      activityForm?.addEventListener("submit", async function (e) {
        e.preventDefault();
        e.stopPropagation();
        hideActivityMessages();

        if (!activityForm.checkValidity()) {
          activityForm.classList.add("was-validated");
          return;
        }

        const formData = new FormData(activityForm);
        if (companyId) formData.append("companyId", companyId);

        const isUpdate = Boolean(activityIdField?.value);
        const targetUrl = isUpdate ? `/api/activities/${encodeURIComponent(activityIdField.value)}` : '/api/activities';
        const method = isUpdate ? "PUT" : "POST";
        const successMessage = isUpdate ? "활동을 수정했습니다." : "활동을 등록했습니다.";

        try {
          activityCreateSpinner?.classList.remove("d-none");
          const res = await fetch(targetUrl, {
            method,
            body: formData
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "저장에 실패했습니다.");
          }
          activityCreateSuccess.textContent = successMessage;
          activityCreateSuccess.classList.remove("d-none");
          await loadActivities();
          if (window.bootstrap?.Modal) {
            window.bootstrap.Modal.getInstance(activityModal)?.hide();
          }
          activityForm.reset();
          activityForm.classList.remove("was-validated");
          activityFields.startAt && (activityFields.startAt.value = nowInputValue());
          activityFields.endAt && (activityFields.endAt.value = nowInputValue());
          activityFields.statusField && (activityFields.statusField.value = DEFAULT_STATUS);
        } catch (err) {
          activityCreateError.textContent = err.message || "오류가 발생했습니다.";
          activityCreateError.classList.remove("d-none");
        } finally {
          activityCreateSpinner?.classList.add("d-none");
        }
      });

      if (reservationSection) {
        const reservationsSpinner = reservationSection.querySelector('[data-role="reservations-spinner"]');
        const reservationsError = reservationSection.querySelector('[data-role="reservations-error"]');
        const reservationsSuccess = reservationSection.querySelector('[data-role="reservations-success"]');
        const reservationsEmpty = reservationSection.querySelector('[data-role="reservations-empty"]');
        const reservationsTableWrapper = reservationSection.querySelector('[data-role="reservations-table-wrapper"]');
        const reservationsTbody = reservationSection.querySelector('[data-role="reservations-table-body"]');
        const reservationsRefresh = reservationSection.querySelector('[data-role="reservations-refresh"]');

        const canManageReservations = isAdmin(role) || status === "APPROVED";
        if (!canManageReservations) {
          reservationSection.classList.add("d-none");
        } else {
          const buildReservationsUrl = (force) => {
            const params = [];
            if (companyId) params.push(`companyId=${encodeURIComponent(companyId)}`);
            if (force) params.push(`t=${Date.now()}`);
            return `/api/reservations/for-company${params.length ? '?' + params.join('&') : ''}`;
          };

          const hideReservationSuccess = () => {
            if (reservationsSuccess) {
              reservationsSuccess.classList.add("d-none");
              reservationsSuccess.textContent = "예약 상태가 업데이트되었습니다.";
            }
          };

          const showReservationSuccess = (message) => {
            if (reservationsSuccess) {
              reservationsSuccess.textContent = message;
              reservationsSuccess.classList.remove("d-none");
            }
          };

          const reservationStatusBadge = (status) => {
            const normalized = String(status || "").toUpperCase();
            let variant = "secondary";
            if (normalized === "CONFIRMED") variant = "success";
            else if (normalized === "PENDING") variant = "warning";
            else if (normalized === "CANCELED") variant = "danger";
            return `<span class="badge bg-${variant}">${escapeHtml(normalized)}</span>`;
          };

          const renderReservations = (items) => {
            if (!reservationsTbody) return;
            reservationsTbody.innerHTML = "";
            items.forEach((item) => {
              const row = document.createElement("tr");
              row.dataset.reservationId = String(item.id);

              let buttons = '';
              const status = (item.status || "").toUpperCase();
              if (status === 'PENDING') {
                buttons = `<button type="button" class="btn btn-outline-success" data-action="approve">승인</button>
                           <button type="button" class="btn btn-outline-danger" data-action="reject">거절</button>`;
              } else if (status === 'CONFIRMED') {
                buttons = `<button type="button" class="btn btn-outline-danger" data-action="reject">예약 취소</button>`;
              }

              row.innerHTML = `
                <td>
                  <div>${escapeHtml(item.touristName || "")}</div>
                  <div class="text-muted small">${escapeHtml(item.touristEmail || "")}</div>
                  <div class="text-muted small">${escapeHtml(item.touristNationality || "")}</div>
                </td>
                <td>
                  <div>${escapeHtml(item.activityTitle || "")}</div>
                  <div class="text-muted small">${formatInterval(item.startAt, item.endAt)}</div>
                </td>
                <td>
                  <div>${formatDateTimeValue(item.createdAt)}</div>
                  ${item.specialRequest ? `<div class="text-muted small">${escapeHtml(item.specialRequest)}</div>` : ''}
                </td>
                <td>${reservationStatusBadge(item.status)}</td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">${buttons}</div>
                </td>
              `;
              reservationsTbody.appendChild(row);
            });
          };

          const loadReservations = async (force = false) => {
            if (!reservationsSpinner || !reservationsError || !reservationsEmpty || !reservationsTableWrapper) {
              return;
            }
            hideReservationSuccess();
            reservationsSpinner.classList.remove("d-none");
            reservationsError.classList.add("d-none");
            reservationsEmpty.classList.add("d-none");
            reservationsTableWrapper.classList.add("d-none");
            if (reservationsTbody) {
              reservationsTbody.innerHTML = "";
            }
            if (reservationsRefresh) {
              reservationsRefresh.disabled = true;
            }

            try {
              const res = await fetch(buildReservationsUrl(force), { credentials: "same-origin", cache: "no-store" });
              if (!res.ok) {
                throw new Error("예약을 불러오지 못했습니다. (HTTP " + res.status + ")");
              }
              const data = await res.json();
              if (!Array.isArray(data) || data.length === 0) {
                reservationsEmpty.classList.remove("d-none");
                return;
              }
              renderReservations(data);
              reservationsTableWrapper.classList.remove("d-none");
            } catch (err) {
              reservationsError.textContent = err.message || "예약 정보를 불러오는 중 오류가 발생했습니다.";
              reservationsError.classList.remove("d-none");
            } finally {
              reservationsSpinner.classList.add("d-none");
              if (reservationsRefresh) {
                reservationsRefresh.disabled = false;
              }
            }
          };

          reservationsRefresh?.addEventListener("click", (event) => {
            event.preventDefault();
            loadReservations(true);
          });

          reservationsTbody?.addEventListener("click", async (event) => {
            const btn = event.target.closest('button[data-action]');
            if (!btn) {
              return;
            }
            const row = btn.closest('tr');
            if (!row) {
              return;
            }
            const reservationId = row.dataset.reservationId;
            if (!reservationId) {
              return;
            }

            const action = btn.dataset.action;
            let endpoint;
            let confirmMessage;
            let successMessage;
            if (action === "approve") {
              endpoint = `/api/reservations/${encodeURIComponent(reservationId)}/approve`;
              confirmMessage = "해당 예약을 승인하시겠습니까?";
              successMessage = "예약을 승인했습니다.";
            } else if (action === "reject") {
              endpoint = `/api/reservations/${encodeURIComponent(reservationId)}/reject`;
              confirmMessage = "해당 예약을 거절/취소하시겠습니까?";
              successMessage = "예약을 거절/취소했습니다.";
            } else {
              return;
            }

            if (!window.confirm(confirmMessage)) {
              return;
            }

            hideReservationSuccess();
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            try {
              const res = await fetch(endpoint, { method: "POST", credentials: "same-origin" });
              if (!res.ok) {
                const textResponse = await res.text();
                throw new Error(textResponse || "예약 상태를 변경하지 못했습니다.");
              }
              showReservationSuccess(successMessage);
              loadReservations(true); // Reload the list
            } catch (err) {
              btn.disabled = false;
              btn.innerHTML = originalHtml;
              window.alert(err.message || "예약 상태 변경 중 오류가 발생했습니다.");
            }
          });

          loadReservations();
        }
      }
    })();
  </script>

  <!-- 스크립트: 모든 업체 관리 -->
  <script>
    (function () {
      const section = document.getElementById("adminAllCompaniesSection");
      if (!section) return;

      const spinner = section.querySelector("#allCompaniesSpinner");
      const errorEl = section.querySelector('[data-role="all-companies-error"]');
      const successEl = section.querySelector('[data-role="all-companies-success"]');
      const emptyEl = section.querySelector('[data-role="all-companies-empty"]');
      const tableWrapper = section.querySelector('[data-role="all-companies-table-wrapper"]');
      const tbody = section.querySelector('[data-role="all-companies-table-body"]');
      const refreshBtn = section.querySelector("#btnRefreshAllCompanies");

      const escape = (str) => String(str || "").replace(/[&<>"']/g, (m) => ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[m]));

      function hideMessages() {
        errorEl?.classList.add("d-none");
        successEl?.classList.add("d-none");
      }

      function showSuccess(message) {
        if (successEl) {
          successEl.textContent = message || "요청이 처리되었습니다.";
          successEl.classList.remove("d-none");
        }
      }

      function verificationBadge(isVerified) {
        return isVerified
                ? `<span class="badge bg-success">활성</span>`
                : `<span class="badge bg-secondary">비활성</span>`;
      }

      async function updateVerificationStatus(companyId, isVerified, btn) {
        hideMessages();
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;

        try {
          const res = await fetch(`/api/company/${encodeURIComponent(companyId)}/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ verified: isVerified })
          });

          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || '상태 변경에 실패했습니다.');
          }

          showSuccess('업체 상태가 성공적으로 변경되었습니다.');
          loadAllCompanies(); // Reload the list to show updated status

        } catch (err) {
          if (errorEl) {
            errorEl.textContent = err.message || "오류가 발생했습니다.";
            errorEl.classList.remove("d-none");
          }
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }

      async function loadAllCompanies() {
        hideMessages();
        spinner?.classList.remove("d-none");
        emptyEl?.classList.add("d-none");
        tableWrapper?.classList.add("d-none");
        tbody && (tbody.innerHTML = "");

        try {
          const res = await fetch("/api/company/all");
          if (!res.ok) throw new Error("업체 목록을 불러오는데 실패했습니다.");

          const companies = await res.json();
          if (!companies || companies.length === 0) {
            emptyEl?.classList.remove("d-none");
            return;
          }

          companies.forEach(company => {
            const tr = document.createElement("tr");
            tr.dataset.companyId = company.id;
            tr.innerHTML = `
              <td>${escape(company.companyName)}</td>
              <td>${escape(company.businessNumber)}</td>
              <td>${escape(company.ceoName)}</td>
              <td>
                <div class="small">${escape(company.ceoContact)}</div>
                <div class="small text-muted">${escape(company.officeContact)}</div>
              </td>
              <td class="text-center">${verificationBadge(company.verified)}</td>
              <td class="text-end">
                  <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-success" data-action="activate" ${company.verified ? 'disabled' : ''}>활성화</button>
                      <button type="button" class="btn btn-outline-secondary" data-action="deactivate" ${!company.verified ? 'disabled' : ''}>비활성화</button>
                  </div>
              </td>
            `;
            tbody?.appendChild(tr);
          });
          tableWrapper?.classList.remove("d-none");

        } catch (err) {
          if (errorEl) {
            errorEl.textContent = err.message || "오류가 발생했습니다.";
            errorEl.classList.remove("d-none");
          }
        } finally {
          spinner?.classList.add("d-none");
        }
      }

      refreshBtn?.addEventListener("click", loadAllCompanies);

      tbody?.addEventListener("click", e => {
        const button = e.target.closest("button[data-action]");
        if (!button) return;

        const row = button.closest("tr[data-company-id]");
        const companyId = row?.dataset.companyId;
        if (!companyId) return;

        const action = button.dataset.action;
        if (action === 'activate') {
          updateVerificationStatus(companyId, true, button);
        } else if (action === 'deactivate') {
          updateVerificationStatus(companyId, false, button);
        }
      });

      // Initial load
      loadAllCompanies();
    })();
  </script>


</div>













<div class="modal fade" id="activityParticipantsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" data-role="participants-modal-title">예약 인원</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center my-3 d-none" data-role="participants-spinner">
          <div class="spinner-border text-secondary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div class="alert alert-danger d-none" data-role="participants-error"></div>
        <div class="alert alert-info d-none" data-role="participants-empty">예약된 인원이 없습니다.</div>
        <div class="table-responsive d-none" data-role="participants-table-wrapper">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col" class="text-center" style="width: 60px;">#</th>
                <th scope="col">이름</th>
                <th scope="col">이메일</th>
                <th scope="col">국적</th>
                <th scope="col" class="text-center">상태</th>
                <th scope="col">요청사항</th>
                <th scope="col">예약일</th>
              </tr>
            </thead>
            <tbody data-role="participants-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const activitiesTbody = document.querySelector('[data-role="activities-table-body"]');
    if (!activitiesTbody) {
      return;
    }

    const participantsModalEl = document.getElementById("activityParticipantsModal");
    if (!participantsModalEl) {
      return;
    }
    const participantsModalTitle = participantsModalEl.querySelector('[data-role="participants-modal-title"]');
    const participantsSpinner = participantsModalEl.querySelector('[data-role="participants-spinner"]');
    const participantsError = participantsModalEl.querySelector('[data-role="participants-error"]');
    const participantsEmpty = participantsModalEl.querySelector('[data-role="participants-empty"]');
    const participantsTableWrapper = participantsModalEl.querySelector('[data-role="participants-table-wrapper"]');
    const participantsTbody = participantsModalEl.querySelector('[data-role="participants-tbody"]');

    if (!participantsTbody) {
      return;
    }

    const escapeHtml = (str) => String(str || "").replace(/[&<>"']/g, (m) => ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[m]));

    const formatDateTimeValue = (value) => {
      if (!value) {
        return "";
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return "";
      }
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      const hh = String(date.getHours()).padStart(2, "0");
      const min = String(date.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
    };

    const reservationStatusBadge = (status) => {
      const normalized = String(status || "").toUpperCase();
      let variant = "secondary";
      if (normalized === "CONFIRMED") {
        variant = "success";
      } else if (normalized === "PENDING") {
        variant = "warning";
      } else if (normalized === "CANCELED") {
        variant = "danger";
      }
      return `<span class="badge bg-${variant}">${escapeHtml(normalized)}</span>`;
    };

    const resetParticipantsModal = (activityTitle) => {
      if (participantsModalTitle) {
        participantsModalTitle.textContent = activityTitle ? `${activityTitle} 예약 인원` : "예약 인원";
      }
      participantsError?.classList.add("d-none");
      participantsEmpty?.classList.add("d-none");
      participantsTableWrapper?.classList.add("d-none");
      participantsSpinner?.classList.add("d-none");
      participantsTbody.innerHTML = "";
    };

    const renderParticipants = (items) => {
      participantsTbody.innerHTML = "";
      items.forEach((item, index) => {
        const row = document.createElement("tr");
        const specialRequestHtml = item.specialRequest ? escapeHtml(item.specialRequest).replace(/\n/g, "<br>") : "-";
        row.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td>${escapeHtml(item.touristName)}</td>
          <td>${escapeHtml(item.touristEmail)}</td>
          <td>${escapeHtml(item.touristNationality)}</td>
          <td class="text-center">${reservationStatusBadge(item.status)}</td>
          <td>${specialRequestHtml}</td>
          <td>${escapeHtml(formatDateTimeValue(item.createdAt))}</td>
        `;
        participantsTbody.appendChild(row);
      });
    };

    const loadActivityParticipants = async (activityId, activityTitle) => {
      resetParticipantsModal(activityTitle);
      const modalInstance = window.bootstrap?.Modal?.getOrCreateInstance(participantsModalEl);
      participantsSpinner?.classList.remove("d-none");
      modalInstance?.show();
      try {
        const response = await fetch(`/api/reservations/activity/${encodeURIComponent(activityId)}`, {
          headers: { "Accept": "application/json" },
          credentials: "same-origin",
          cache: "no-store"
        });
        if (!response.ok) {
          throw new Error("예약 정보를 불러오지 못했습니다.");
        }
        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) {
          participantsEmpty?.classList.remove("d-none");
          return;
        }
        renderParticipants(data);
        participantsTableWrapper?.classList.remove("d-none");
      } catch (error) {
        if (participantsError) {
          participantsError.textContent = error.message || "예약 정보를 불러오는 중 오류가 발생했습니다.";
          participantsError.classList.remove("d-none");
        }
      } finally {
        participantsSpinner?.classList.add("d-none");
      }
    };

    const transformRow = (row) => {
      if (!row) {
        return;
      }
      const cells = row.children;
      if (!cells || cells.length < 6) {
        return;
      }
      const cell = cells[5];
      if (!cell || cell.querySelector('[data-role="activity-reservations"]')) {
        return;
      }
      const count = (cell.textContent || "").trim() || "0";
      const button = document.createElement("button");
      button.type = "button";
      button.className = "btn btn-link p-0";
      button.dataset.role = "activity-reservations";
      const activityData = row.__activityData || {};
      const titleSource = activityData.title || row.querySelector('[data-role="activity-edit"]')?.textContent?.trim() || "";
      button.dataset.activityTitle = titleSource;
      button.textContent = count;
      cell.textContent = "";
      cell.appendChild(button);
    };

    Array.from(activitiesTbody.children).forEach(transformRow);

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes?.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE && node.matches("tr")) {
            transformRow(node);
          }
        });
      });
    });

    observer.observe(activitiesTbody, { childList: true });

    activitiesTbody.addEventListener("click", (event) => {
      const button = event.target.closest('[data-role="activity-reservations"]');
      if (!button) {
        return;
      }
      event.preventDefault();
      const row = button.closest("tr");
      const activityId = row?.dataset.activityId;
      if (!activityId) {
        return;
      }
      const activityData = row?.__activityData;
      const title = button.dataset.activityTitle || activityData?.title || "";
      loadActivityParticipants(activityId, title);
    });
  })();
</script>
