<!-- fragments/company-dashboard.html -->
<div th:fragment="companyDashboard">
  <section id="companyDashboardRoot"
           class="container"
           style="margin-top: 110px;"
           th:attr="data-role=${companyRole}, data-status=${companyStatus}, data-company-name=${companyName}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="fw-bold mb-0"><span th:text="${companyRole} == 'ADMIN' ? '시스템관리자' : (${companyName} ?: '업체')"></span> 대시보드</h3>
        <div class="text-muted">안녕하세요, <span th:text="${companyUserName} ?: '담당자'">담당자</span> 님</div>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadPage(event, '/fragments/home')">홈으로</button>
      </div>
    </div>

    <div id="pendingNotice" class="alert alert-warning d-none">
      업체 승인 대기중입니다. 관리자 승인 후에 주요 기능을 사용할 수 있습니다.
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">등록된 활동</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">오늘 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">진행 중 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" onclick="alert('활동 등록 화면은 추후 연동될 예정입니다.')">활동 등록</button>
        <button class="btn btn-outline-primary" onclick="alert('예약 관리 화면은 추후 연동될 예정입니다.')">예약 관리</button>
        <button class="btn btn-outline-primary" onclick="alert('정산/통계 화면은 추후 연동될 예정입니다.')">정산/통계</button>
      </div>
    </div>

    <div id="adminApprovalSection" class="card shadow-sm rounded-4 p-3 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">승인 대기중인 업체</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshPending">새로고침</button>
      </div>
      <div class="small text-muted mb-2">승인 완료된 업체와 담당자 계정은 즉시 대시보드에서 사용할 수 있습니다.</div>
      <div data-role="loading" class="text-center py-3">불러오는 중...</div>
      <div data-role="error" class="alert alert-danger d-none"></div>
      <div data-role="empty" class="alert alert-info d-none">승인 대기중인 업체가 없습니다.</div>
      <div class="table-responsive d-none" data-role="table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">업체명</th>
              <th scope="col">사업자번호</th>
              <th scope="col">대표자</th>
              <th scope="col">담당자 계정</th>
              <th scope="col" class="text-end">승인</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
  (function(){
    const root = document.getElementById('companyDashboardRoot');
    if (!root) return;

    const role = (root.dataset.role || 'COMPANY').toUpperCase();
    const status = (root.dataset.status || '').toUpperCase();

    const pendingNotice = document.getElementById('pendingNotice');
    if (pendingNotice && role !== 'ADMIN' && status === 'PENDING') {
      pendingNotice.classList.remove('d-none');
    }

    if (role === 'ADMIN') {
      initAdminSection();
    }
  })();

  function initAdminSection(){
    const section = document.getElementById('adminApprovalSection');
    if (!section) return;

    const loadingEl = section.querySelector('[data-role="loading"]');
    const errorEl = section.querySelector('[data-role="error"]');
    const emptyEl = section.querySelector('[data-role="empty"]');
    const tableWrapper = section.querySelector('[data-role="table-wrapper"]');
    const tbody = tableWrapper?.querySelector('tbody');
    const refreshBtn = document.getElementById('btnRefreshPending');

    const setState = (state) => {
      if (loadingEl) loadingEl.classList.toggle('d-none', state !== 'loading');
      if (errorEl) errorEl.classList.toggle('d-none', state !== 'error');
      if (emptyEl) emptyEl.classList.toggle('d-none', state !== 'empty');
      if (tableWrapper) tableWrapper.classList.toggle('d-none', state !== 'table');
    };

    const renderRows = (items) => {
      if (!tbody) return;
      tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.userId = String(item.userId);
        tr.dataset.companyId = String(item.companyId);
        tr.innerHTML = `
          <td>${escapeHtml(item.companyName)}</td>
          <td>${escapeHtml(item.businessNumber || '-')}</td>
          <td>
            <div>${escapeHtml(item.ceoName || '-')}</div>
            <div class="text-muted small">${escapeHtml(item.ceoContact || '')}</div>
          </td>
          <td>
            <div>${escapeHtml(item.username || '-')}</div>
            <div class="text-muted small">신청일 ${formatDateTime(item.companyCreatedAt)}</div>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-success" data-action="approve">승인</button>
          </td>`;
        tbody.appendChild(tr);
      });
    };

    const loadPending = async () => {
      setState('loading');
      try{
        const res = await fetch('/api/company/pending-requests', { credentials: 'same-origin' });
        if(!res.ok){
          throw new Error('목록을 불러오지 못했습니다. (HTTP ' + res.status + ')');
        }
        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0){
          setState('empty');
          return;
        }
        renderRows(data);
        setState('table');
      }catch(err){
        if (errorEl) errorEl.textContent = err.message;
        setState('error');
      }
    };

    section.classList.remove('d-none');
    loadPending();

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => loadPending());
    }

    if (tbody) {
      tbody.addEventListener('click', async (event) => {
        const btn = event.target.closest('button[data-action="approve"]');
        if (!btn) return;
        const row = btn.closest('tr');
        if (!row) return;
        const userId = row.dataset.userId;
        const companyId = row.dataset.companyId;
        if (!userId || !companyId) return;
        if (!confirm('해당 업체를 승인하시겠습니까?')) return;
        try{
          const res = await fetch(`/api/company/pending/${encodeURIComponent(userId)}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ companyId: Number(companyId) })
          });
          if(!res.ok){
            throw new Error('승인 처리에 실패했습니다. (HTTP ' + res.status + ')');
          }
          row.remove();
          if (tbody.children.length === 0) {
            setState('empty');
          }
        }catch(err){
          alert(err.message);
        }
      });
    }
  }

  function escapeHtml(value){
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatDateTime(value){
    if(!value) return '-';
    try{
      const date = new Date(value);
      if(Number.isNaN(date.getTime())) return '-';
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
    }catch(_err){
      return '-';
    }
  }
</script>