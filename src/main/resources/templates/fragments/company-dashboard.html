<!-- fragments/company-dashboard.html -->
<div th:fragment="companyDashboard">
  <section id="companyDashboardRoot"
           class="container"
           style="margin-top: 110px;"
           th:attr="data-role=${companyRole}, data-status=${companyStatus}, data-company-name=${companyName}, data-company-id=${companyId}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="fw-bold mb-0"><span th:text="${companyRole} == 'ADMIN' ? '시스템 관리자' : (${companyName} ?: '업체')"></span> 대시보드</h3>
        <div class="text-muted">안녕하세요, <span th:text="${companyUserName} ?: '담당자'">담당자</span>님</div>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadPage(event, '/fragments/home')">홈으로</button>
      </div>
    </div>

    <div id="pendingNotice" class="alert alert-warning d-none">
      업체 승인 대기 중입니다. 관리자 승인 완료 후 주요 기능을 이용할 수 있습니다.
    </div>

    <div class="row g-3 mb-4" data-role="dashboard-summary">
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">등록된 활동</div>
          <div class="fs-4 fw-bold" id="summaryActivitiesCount">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">오늘 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">진행 중 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#activityCreateModal">활동 등록</button>
        <button class="btn btn-outline-primary" onclick="alert('예약 관리 화면은 추후 연동될 예정입니다.')">예약 관리</button>
        <button class="btn btn-outline-primary" onclick="alert('정산/통계 화면은 추후 연동될 예정입니다.')">정산/통계</button>
      </div>
    </div>

    <!-- 등록된 활동 목록 (승인 대기 업체 섹션과 유사한 UI) -->
    <div id="activityListSection" class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">등록된 활동</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="activitiesSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshActivities">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">업체가 등록한 활동 목록입니다. 수정/비활성화는 추후 기능으로 연동됩니다.</div>
      <div data-role="activities-error" class="alert alert-danger d-none"></div>
      <div data-role="activities-success" class="alert alert-success d-none">요청이 정상 처리되었습니다.</div>
      <div data-role="activities-empty" class="alert alert-info d-none">등록된 활동이 없습니다.</div>
      <div class="table-responsive d-none" data-role="activities-table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">활동명</th>
              <th scope="col">카테고리</th>
              <th scope="col">위치</th>
              <th scope="col">운영일시</th>
              <th scope="col" class="text-end">상태</th>
            </tr>
          </thead>
          <tbody data-role="activities-table-body"></tbody>
        </table>
      </div>
    </div>


    
    <div id="reservationPendingSection" class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">예약 승인 대기</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" data-role="reservations-spinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-role="reservations-refresh">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">승인 대기 중인 예약을 확인하고 처리할 수 있습니다.</div>
      <div class="alert alert-danger d-none" data-role="reservations-error"></div>
      <div class="alert alert-success d-none" data-role="reservations-success">예약 상태가 업데이트되었습니다.</div>
      <div class="alert alert-info d-none" data-role="reservations-empty">승인 대기 중인 예약이 없습니다.</div>
      <div class="table-responsive d-none" data-role="reservations-table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">예약자</th>
              <th scope="col">활동</th>
              <th scope="col">요청 정보</th>
              <th scope="col" class="text-end">처리</th>
            </tr>
          </thead>
          <tbody data-role="reservations-table-body"></tbody>
        </table>
      </div>
    </div>
<div id="adminApprovalSection" class="card shadow-sm rounded-4 p-3" th:classappend="${#strings.equalsIgnoreCase(companyRole, 'ADMIN')} ? '' : ' d-none'">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">승인 대기 업체</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="pendingSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshPending">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">승인이 완료되면 담당자 계정으로 대시보드를 이용할 수 있습니다.</div>
      <div data-role="error" class="alert alert-danger d-none"></div>
      <div data-role="success" class="alert alert-success d-none">선택한 업체를 승인했습니다.</div>
      <div data-role="empty" class="alert alert-info d-none">승인 대기 중인 업체가 없습니다.</div>
      <div class="table-responsive d-none" data-role="table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">업체명</th>
              <th scope="col">사업자등록번호</th>
              <th scope="col">대표자</th>
              <th scope="col">담당자 정보</th>
              <th scope="col" class="text-end" data-role="action-header">승인</th>
            </tr>
          </thead>
          <tbody data-role="pending-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 활동 등록 모달 -->
  <div class="modal fade" id="activityCreateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">활동 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="activityCreateForm" class="needs-validation" novalidate>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">활동명 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="title" required placeholder="예) 한강 일몰 카약 투어">
                <div class="invalid-feedback">활동명을 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">카테고리</label>
                <select class="form-select" name="category">
                  <option value="">선택</option>
                  <option>육상</option>
                  <option>수상</option>
                  <option>공중</option>
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">위치(만남 장소) <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="location" required placeholder="예) 뚝섬 한강공원 카약장 입구">
                <div class="invalid-feedback">위치를 입력하세요.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">정원(명)</label>
                <input type="number" class="form-control" name="capacity" min="1" placeholder="예) 12">
              </div>
              <div class="col-md-6">
                <label class="form-label">시작일시 <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" name="startAt" required>
                <div class="invalid-feedback">시작일시를 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">종료일시 <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" name="endAt" required>
                <div class="invalid-feedback">종료일시를 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">가격(원)</label>
                <input type="number" class="form-control" name="price" min="0" step="1000" placeholder="예) 35000">
              </div>
              <div class="col-md-6">
                <label class="form-label">노출 상태</label>
                <select class="form-select" name="status">
                  <option value="DRAFT">작성중</option>
                  <option value="PUBLISHED">노출</option>
                  <option value="HIDDEN">비노출</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">설명</label>
                <textarea class="form-control" name="description" rows="4" placeholder="활동 소개, 준비물, 유의사항 등을 입력"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">대표 이미지</label>
                <input type="file" class="form-control" name="image">
              </div>
            </div>
            <div class="alert alert-danger d-none mt-3" id="activityCreateError"></div>
            <div class="alert alert-success d-none mt-3" id="activityCreateSuccess">활동이 등록되었습니다.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
            <button type="submit" class="btn btn-primary" id="activityModalSubmit">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="activityCreateSpinner" role="status" aria-hidden="true"></span>
              저장
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 스크립트: 활동 목록 로드 & 활동 등록 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      // yyyy-MM-ddTHH:mm 형식으로 변환
      const pad = n => String(n).padStart(2, '0');
      const todayStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;

      // 시작/종료 일시 input에 값 설정
      const startInput = document.querySelector('input[name="startAt"]');
      const endInput   = document.querySelector('input[name="endAt"]');

      if (startInput) startInput.value = todayStr;
      if (endInput)   endInput.value   = todayStr;
    });
    (function () {
      const root = document.getElementById('companyDashboardRoot');
      const companyId = root?.dataset.companyId;
      const role = (root?.dataset.role || '').toUpperCase();
      const status = (root?.dataset.status || '').toUpperCase();

      // 승인 대기 알림 토글 (회사 계정 & 상태 PENDING)
      const pendingNotice = document.getElementById('pendingNotice');
      if (pendingNotice && role !== 'ADMIN' && (status === 'PENDING' || status === 'UNASSIGNED')) {
        pendingNotice.classList.remove('d-none');
      }

      // 등록된 활동 목록 로딩
      const btnRefreshActivities = document.getElementById('btnRefreshActivities');
      const activitiesSpinner = document.getElementById('activitiesSpinner');
      const activitiesError = document.querySelector('[data-role="activities-error"]');
      const activitiesEmpty = document.querySelector('[data-role="activities-empty"]');
      const activitiesTableWrapper = document.querySelector('[data-role="activities-table-wrapper"]');
      const activitiesTbody = document.querySelector('[data-role="activities-table-body"]');
      const summaryActivitiesCount = document.getElementById('summaryActivitiesCount');

      async function loadActivities() {
        if (!activitiesSpinner) return;
        activitiesSpinner.classList.remove('d-none');
        activitiesError.classList.add('d-none');
        activitiesEmpty.classList.add('d-none');
        activitiesTableWrapper.classList.add('d-none');
        activitiesTbody.innerHTML = '';
        try {
          const url = companyId ? `/api/companies/${companyId}/activities` : `/api/activities/mine`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('활동 목록을 불러오지 못했습니다.');
          const items = await res.json();
          if (!items || items.length === 0) {
            activitiesEmpty.classList.remove('d-none');
            summaryActivitiesCount && (summaryActivitiesCount.textContent = '0');
          } else {
            items.forEach(row => {
              const tr = document.createElement('tr');
              const opInterval = formatInterval(row.startAt, row.endAt);
              tr.innerHTML = `
                <td><a href="/activities/${row.id}" class="text-decoration-none">${escapeHtml(row.title || '')}</a></td>
                <td>${escapeHtml(row.category || '')}</td>
                <td>${escapeHtml(row.location || '')}</td>
                <td>${opInterval}</td>
                <td class="text-end"><span class="badge bg-${statusBadge(row.status)}">${escapeHtml(row.status || '')}</span></td>
              `;
              activitiesTbody.appendChild(tr);
            });
            activitiesTableWrapper.classList.remove('d-none');
            summaryActivitiesCount && (summaryActivitiesCount.textContent = String(items.length));
          }
        } catch (err) {
          activitiesError.textContent = err.message || '오류가 발생했습니다.';
          activitiesError.classList.remove('d-none');
        } finally {
          activitiesSpinner.classList.add('d-none');
        }
      }

      function statusBadge(s) {
        const k = String(s || '').toUpperCase();
        if (k === 'PUBLISHED') return 'success';
        if (k === 'HIDDEN') return 'secondary';
        return 'warning'; // DRAFT 등
      }

      function formatInterval(startAt, endAt) {
        if (!startAt && !endAt) return '';
        const s = startAt ? new Date(startAt) : null;
        const e = endAt ? new Date(endAt) : null;
        const k = (d) => isNaN(d?.getTime?.()) ? '' : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        return `${k(s)} ~ ${k(e)}`.trim();
      }

      function formatDateTimeValue(value) {
        if (!value) return '';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return '';
        }
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
      }
      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      }

      btnRefreshActivities?.addEventListener('click', loadActivities);
      // 초기 로드
      loadActivities();

      // 활동 등록 폼
      const activityForm = document.getElementById('activityCreateForm');
      const activityCreateSpinner = document.getElementById('activityCreateSpinner');
      const activityCreateError = document.getElementById('activityCreateError');
      const activityCreateSuccess = document.getElementById('activityCreateSuccess');

      // 부트스트랩 폼 검증
      activityForm?.addEventListener('submit', async function (e) {
        e.preventDefault();
        e.stopPropagation();
        activityCreateError.classList.add('d-none');
        activityCreateSuccess.classList.add('d-none');

        if (!activityForm.checkValidity()) {
          activityForm.classList.add('was-validated');
          return;
        }

        const formData = new FormData(activityForm);
        if (companyId) formData.append('companyId', companyId);

        try {
          activityCreateSpinner.classList.remove('d-none');
          const res = await fetch('/api/activities', {
            method: 'POST',
            body: formData
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || '저장에 실패했습니다.');
          }
          activityCreateSuccess.classList.remove('d-none');
          // 목록 새로고침
          await loadActivities();
          // 요약 갱신은 loadActivities에서 처리됨
          // 폼 초기화
          activityForm.reset();
          activityForm.classList.remove('was-validated');
        } catch (err) {
          activityCreateError.textContent = err.message || '오류가 발생했습니다.';
          activityCreateError.classList.remove('d-none');
        } finally {
          activityCreateSpinner.classList.add('d-none');
        }
      });
      const reservationSection = document.getElementById('reservationPendingSection');
      if (reservationSection) {
        const reservationsSpinner = reservationSection.querySelector('[data-role="reservations-spinner"]');
        const reservationsError = reservationSection.querySelector('[data-role="reservations-error"]');
        const reservationsSuccess = reservationSection.querySelector('[data-role="reservations-success"]');
        const reservationsEmpty = reservationSection.querySelector('[data-role="reservations-empty"]');
        const reservationsTableWrapper = reservationSection.querySelector('[data-role="reservations-table-wrapper"]');
        const reservationsTbody = reservationSection.querySelector('[data-role="reservations-table-body"]');
        const reservationsRefresh = reservationSection.querySelector('[data-role="reservations-refresh"]');

        const canManageReservations = role === 'ADMIN' || status === 'APPROVED';
        if (!canManageReservations) {
          reservationSection.classList.add('d-none');
        } else {
          const buildReservationsUrl = (force) => {
            const params = [];
            if (companyId) params.push(`companyId=${encodeURIComponent(companyId)}`);
            if (force) params.push(`t=${Date.now()}`);
            return `/api/reservations/pending${params.length ? '?' + params.join('&') : ''}`;
          };

          const hideReservationSuccess = () => {
            if (reservationsSuccess) {
              reservationsSuccess.classList.add('d-none');
              reservationsSuccess.textContent = '예약 상태가 업데이트되었습니다.';
            }
          };

          const showReservationSuccess = (message) => {
            if (reservationsSuccess) {
              reservationsSuccess.textContent = message;
              reservationsSuccess.classList.remove('d-none');
            }
          };

          const renderReservations = (items) => {
            if (!reservationsTbody) return;
            reservationsTbody.innerHTML = '';
            items.forEach((item) => {
              const row = document.createElement('tr');
              row.dataset.reservationId = String(item.id);
              row.innerHTML = `
                <td>
                  <div>${escapeHtml(item.touristName || '')}</div>
                  <div class="text-muted small">${escapeHtml(item.touristEmail || '')}</div>
                  <div class="text-muted small">${escapeHtml(item.touristNationality || '')}</div>
                </td>
                <td>
                  <div>${escapeHtml(item.activityTitle || '')}</div>
                  <div class="text-muted small">${formatInterval(item.startAt, item.endAt)}</div>
                </td>
                <td>
                  <div>${formatDateTimeValue(item.createdAt)}</div>
                  ${item.specialRequest ? `<div class="text-muted small">${escapeHtml(item.specialRequest)}</div>` : ''}
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-success" data-action="approve">승인</button>
                    <button type="button" class="btn btn-outline-danger" data-action="reject">거절</button>
                  </div>
                </td>
              `;
              reservationsTbody.appendChild(row);
            });
          };

          const loadReservations = async (force = false) => {
            if (!reservationsSpinner || !reservationsError || !reservationsEmpty || !reservationsTableWrapper) {
              return;
            }
            hideReservationSuccess();
            reservationsSpinner.classList.remove('d-none');
            reservationsError.classList.add('d-none');
            reservationsEmpty.classList.add('d-none');
            reservationsTableWrapper.classList.add('d-none');
            if (reservationsTbody) {
              reservationsTbody.innerHTML = '';
            }
            if (reservationsRefresh) {
              reservationsRefresh.disabled = true;
            }

            try {
              const res = await fetch(buildReservationsUrl(force), { credentials: 'same-origin', cache: 'no-store' });
              if (!res.ok) {
                throw new Error('예약 목록을 불러오지 못했습니다.');
              }
              const data = await res.json();
              if (!Array.isArray(data) || data.length === 0) {
                reservationsEmpty.classList.remove('d-none');
                return;
              }
              renderReservations(data);
              reservationsTableWrapper.classList.remove('d-none');
            } catch (err) {
              if (reservationsError) {
                reservationsError.textContent = err.message || '예약 조회 중 오류가 발생했습니다.';
                reservationsError.classList.remove('d-none');
              }
            } finally {
              if (reservationsSpinner) {
                reservationsSpinner.classList.add('d-none');
              }
              if (reservationsRefresh) {
                reservationsRefresh.disabled = false;
              }
            }
          };

          reservationsRefresh?.addEventListener('click', (event) => {
            event.preventDefault();
            loadReservations(true);
          });

          reservationsTbody?.addEventListener('click', async (event) => {
            const btn = event.target.closest('button[data-action]');
            if (!btn) return;
            const row = btn.closest('tr');
            if (!row) return;
            const reservationId = row.dataset.reservationId;
            if (!reservationId) return;

            const action = btn.dataset.action;
            let endpoint;
            let confirmMessage;
            let successMessage;
            if (action === 'approve') {
              endpoint = `/api/reservations/${encodeURIComponent(reservationId)}/approve`;
              confirmMessage = '해당 예약을 승인하시겠습니까?';
              successMessage = '예약을 승인했습니다.';
            } else if (action === 'reject') {
              endpoint = `/api/reservations/${encodeURIComponent(reservationId)}/reject`;
              confirmMessage = '해당 예약을 거절하시겠습니까?';
              successMessage = '예약을 거절했습니다.';
            } else {
              return;
            }

            if (!window.confirm(confirmMessage)) {
              return;
            }

            hideReservationSuccess();
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            try {
              const res = await fetch(endpoint, { method: 'POST', credentials: 'same-origin' });
              if (!res.ok) {
                const text = await res.text();
                throw new Error(text || '예약 상태를 변경하지 못했습니다.');
              }
              row.remove();
              if (!reservationsTbody || reservationsTbody.children.length === 0) {
                reservationsTableWrapper?.classList.add('d-none');
                reservationsEmpty?.classList.remove('d-none');
              }
              showReservationSuccess(successMessage);
            } catch (err) {
              btn.disabled = false;
              btn.innerHTML = originalHtml;
              window.alert(err.message || '예약 상태 변경 중 오류가 발생했습니다.');
            }
          });

          loadReservations();
        }
      }
    })();
  </script>
</div>






