<!-- fragments/company-dashboard.html -->
<div th:fragment="companyDashboard">
  <section id="companyDashboardRoot"
           class="container"
           style="margin-top: 110px;"
           th:attr="data-role=${companyRole}, data-status=${companyStatus}, data-company-name=${companyName}, data-company-id=${companyId}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="fw-bold mb-0"><span th:text="${companyRole} == 'ADMIN' ? '시스템 관리자' : (${companyName} ?: '업체')"></span> 대시보드</h3>
        <div class="text-muted">안녕하세요, <span th:text="${companyUserName} ?: '담당자'">담당자</span>님</div>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadPage(event, '/fragments/home')">홈으로</button>
      </div>
    </div>

    <div id="pendingNotice" class="alert alert-warning d-none">
      업체 승인 대기 중입니다. 관리자 승인 완료 후 주요 기능을 이용할 수 있습니다.
    </div>

    <div class="row g-3 mb-4" data-role="dashboard-summary">
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">등록된 활동</div>
          <div class="fs-4 fw-bold" id="summaryActivitiesCount">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">오늘 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 p-3">
          <div class="small text-muted">진행 중 예약</div>
          <div class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#activityCreateModal">활동 등록</button>
        <button class="btn btn-outline-primary" onclick="alert('예약 관리 화면은 추후 연동될 예정입니다.')">예약 관리</button>
        <button class="btn btn-outline-primary" onclick="alert('정산/통계 화면은 추후 연동될 예정입니다.')">정산/통계</button>
      </div>
    </div>

    <!-- 등록된 활동 목록 (승인 대기 업체 섹션과 유사한 UI) -->
    <div id="activityListSection" class="card shadow-sm rounded-4 p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">등록된 활동</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="activitiesSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshActivities">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">업체가 등록한 활동 목록입니다. 수정/비활성화는 추후 기능으로 연동됩니다.</div>
      <div data-role="activities-error" class="alert alert-danger d-none"></div>
      <div data-role="activities-success" class="alert alert-success d-none">요청이 정상 처리되었습니다.</div>
      <div data-role="activities-empty" class="alert alert-info d-none">등록된 활동이 없습니다.</div>
      <div class="table-responsive d-none" data-role="activities-table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">활동명</th>
              <th scope="col">카테고리</th>
              <th scope="col">위치</th>
              <th scope="col">운영일시</th>
              <th scope="col" class="text-end">상태</th>
            </tr>
          </thead>
          <tbody data-role="activities-table-body"></tbody>
        </table>
      </div>
    </div>


    <div id="adminApprovalSection" class="card shadow-sm rounded-4 p-3" th:classappend="${#strings.equalsIgnoreCase(companyRole, 'ADMIN')} ? '' : ' d-none'">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">승인 대기 업체</h5>
        <div class="d-flex gap-2">
          <div class="spinner-border spinner-border-sm text-secondary d-none" role="status" id="pendingSpinner">
            <span class="visually-hidden">Loading...</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btnRefreshPending">새로고침</button>
        </div>
      </div>
      <div class="small text-muted mb-2">승인이 완료되면 담당자 계정으로 대시보드를 이용할 수 있습니다.</div>
      <div data-role="error" class="alert alert-danger d-none"></div>
      <div data-role="success" class="alert alert-success d-none">선택한 업체를 승인했습니다.</div>
      <div data-role="empty" class="alert alert-info d-none">승인 대기 중인 업체가 없습니다.</div>
      <div class="table-responsive d-none" data-role="table-wrapper">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">업체명</th>
              <th scope="col">사업자등록번호</th>
              <th scope="col">대표자</th>
              <th scope="col">담당자 정보</th>
              <th scope="col" class="text-end" data-role="action-header">승인</th>
            </tr>
          </thead>
          <tbody data-role="pending-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 활동 등록 모달 -->
  <div class="modal fade" id="activityCreateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">활동 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="activityCreateForm" class="needs-validation" novalidate>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">활동명 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="title" required placeholder="예) 한강 일몰 카약 투어">
                <div class="invalid-feedback">활동명을 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">카테고리</label>
                <select class="form-select" name="category">
                  <option value="">선택</option>
                  <option>카약</option>
                  <option>요트</option>
                  <option>자전거</option>
                  <option>피크닉</option>
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">위치(만남 장소) <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="location" required placeholder="예) 뚝섬 한강공원 카약장 입구">
                <div class="invalid-feedback">위치를 입력하세요.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">정원(명)</label>
                <input type="number" class="form-control" name="capacity" min="1" placeholder="예) 12">
              </div>
              <div class="col-md-6">
                <label class="form-label">시작일시 <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" name="startAt" required>
                <div class="invalid-feedback">시작일시를 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">종료일시 <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" name="endAt" required>
                <div class="invalid-feedback">종료일시를 입력하세요.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">가격(원)</label>
                <input type="number" class="form-control" name="price" min="0" step="1000" placeholder="예) 35000">
              </div>
              <div class="col-md-6">
                <label class="form-label">노출 상태</label>
                <select class="form-select" name="status">
                  <option value="DRAFT">작성중</option>
                  <option value="PUBLISHED">노출</option>
                  <option value="HIDDEN">비노출</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">설명</label>
                <textarea class="form-control" name="description" rows="4" placeholder="활동 소개, 준비물, 유의사항 등을 입력"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">대표 이미지</label>
                <input type="file" class="form-control" name="image">
              </div>
            </div>
            <div class="alert alert-danger d-none mt-3" id="activityCreateError"></div>
            <div class="alert alert-success d-none mt-3" id="activityCreateSuccess">활동이 등록되었습니다.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
            <button type="submit" class="btn btn-primary" id="activityModalSubmit">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="activityCreateSpinner" role="status" aria-hidden="true"></span>
              저장
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 스크립트: 활동 목록 로드 & 활동 등록 -->
  <script>
    (function () {
      const root = document.getElementById('companyDashboardRoot');
      const companyId = root?.dataset.companyId;
      const role = (root?.dataset.role || '').toUpperCase();
      const status = (root?.dataset.status || '').toUpperCase();

      // 승인 대기 알림 토글 (회사 계정 & 상태 PENDING)
      const pendingNotice = document.getElementById('pendingNotice');
      if (pendingNotice && role !== 'ADMIN' && (status === 'PENDING' || status === 'UNASSIGNED')) {
        pendingNotice.classList.remove('d-none');
      }

      // 등록된 활동 목록 로딩
      const btnRefreshActivities = document.getElementById('btnRefreshActivities');
      const activitiesSpinner = document.getElementById('activitiesSpinner');
      const activitiesError = document.querySelector('[data-role="activities-error"]');
      const activitiesEmpty = document.querySelector('[data-role="activities-empty"]');
      const activitiesTableWrapper = document.querySelector('[data-role="activities-table-wrapper"]');
      const activitiesTbody = document.querySelector('[data-role="activities-table-body"]');
      const summaryActivitiesCount = document.getElementById('summaryActivitiesCount');

      async function loadActivities() {
        if (!activitiesSpinner) return;
        activitiesSpinner.classList.remove('d-none');
        activitiesError.classList.add('d-none');
        activitiesEmpty.classList.add('d-none');
        activitiesTableWrapper.classList.add('d-none');
        activitiesTbody.innerHTML = '';
        try {
          const url = companyId ? `/api/companies/${companyId}/activities` : `/api/activities/mine`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('활동 목록을 불러오지 못했습니다.');
          const items = await res.json();
          if (!items || items.length === 0) {
            activitiesEmpty.classList.remove('d-none');
            summaryActivitiesCount && (summaryActivitiesCount.textContent = '0');
          } else {
            items.forEach(row => {
              const tr = document.createElement('tr');
              const opInterval = formatInterval(row.startAt, row.endAt);
              tr.innerHTML = `
                <td><a href="/activities/${row.id}" class="text-decoration-none">${escapeHtml(row.title || '')}</a></td>
                <td>${escapeHtml(row.category || '')}</td>
                <td>${escapeHtml(row.location || '')}</td>
                <td>${opInterval}</td>
                <td class="text-end"><span class="badge bg-${statusBadge(row.status)}">${escapeHtml(row.status || '')}</span></td>
              `;
              activitiesTbody.appendChild(tr);
            });
            activitiesTableWrapper.classList.remove('d-none');
            summaryActivitiesCount && (summaryActivitiesCount.textContent = String(items.length));
          }
        } catch (err) {
          activitiesError.textContent = err.message || '오류가 발생했습니다.';
          activitiesError.classList.remove('d-none');
        } finally {
          activitiesSpinner.classList.add('d-none');
        }
      }

      function statusBadge(s) {
        const k = String(s || '').toUpperCase();
        if (k === 'PUBLISHED') return 'success';
        if (k === 'HIDDEN') return 'secondary';
        return 'warning'; // DRAFT 등
      }

      function formatInterval(startAt, endAt) {
        if (!startAt && !endAt) return '';
        const s = startAt ? new Date(startAt) : null;
        const e = endAt ? new Date(endAt) : null;
        const k = (d) => isNaN(d?.getTime?.()) ? '' : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        return `${k(s)} ~ ${k(e)}`.trim();
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      }

      btnRefreshActivities?.addEventListener('click', loadActivities);
      // 초기 로드
      loadActivities();

      // 활동 등록 폼
      const activityForm = document.getElementById('activityCreateForm');
      const activityCreateSpinner = document.getElementById('activityCreateSpinner');
      const activityCreateError = document.getElementById('activityCreateError');
      const activityCreateSuccess = document.getElementById('activityCreateSuccess');

      // 부트스트랩 폼 검증
      activityForm?.addEventListener('submit', async function (e) {
        e.preventDefault();
        e.stopPropagation();
        activityCreateError.classList.add('d-none');
        activityCreateSuccess.classList.add('d-none');

        if (!activityForm.checkValidity()) {
          activityForm.classList.add('was-validated');
          return;
        }

        const formData = new FormData(activityForm);
        if (companyId) formData.append('companyId', companyId);

        try {
          activityCreateSpinner.classList.remove('d-none');
          const res = await fetch('/api/activities', {
            method: 'POST',
            body: formData
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || '저장에 실패했습니다.');
          }
          activityCreateSuccess.classList.remove('d-none');
          // 목록 새로고침
          await loadActivities();
          // 요약 갱신은 loadActivities에서 처리됨
          // 폼 초기화
          activityForm.reset();
          activityForm.classList.remove('was-validated');
        } catch (err) {
          activityCreateError.textContent = err.message || '오류가 발생했습니다.';
          activityCreateError.classList.remove('d-none');
        } finally {
          activityCreateSpinner.classList.add('d-none');
        }
      });
    })();
  </script>
</div>
