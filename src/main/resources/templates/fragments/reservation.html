<!-- fragments/reservation.html -->
<div th:fragment="reservation" style="background-color:#0d6efd">
  <div class="container-fluid mt-5">
    <div class="row">

      <!-- 좌측 사이드바 + 검색 조건 -->
      <div class="col-xl-3 col-lg-4 mb-4">
        <div class="position-sticky" style="top: 100px;">
          <div class="card shadow-sm p-3">
            <h5 class="mb-3">검색 조건</h5>

            <!-- 지역 선택 -->
            <div class="mb-3">
              <label class="form-label d-block">지역</label>
              <select id="regionSelectSide" class="form-select form-select-sm">
                <option value="" th:selected="${param.region} == null or ${param.region} == ''">전체</option>
                <option value="광진구" th:selected="${param.region} == '광진구'">광진구</option>
                <option value="강남구" th:selected="${param.region} == '강남구'">강남구</option>
                <option value="마포구" th:selected="${param.region} == '마포구'">마포구</option>
                <option value="송파구" th:selected="${param.region} == '송파구'">송파구</option>
                <option value="양천구" th:selected="${param.region} == '양천구'">양천구</option>
                <!-- home에서 온 값이 위 옵션에 없을 때도 선택 표시되도록 동적 옵션 추가 -->
                <option th:if="${param.region != null and param.region != '' and 
                                  !(param.region == '광진구' or param.region == '강남구' or param.region == '마포구' or param.region == '송파구' or param.region == '양천구')}"
                        th:value="${param.region}"
                        th:text="${param.region}"
                        selected>
                </option>
              </select>
            </div>

            <!-- 날짜 범위 -->
            <div class="mb-3">
              <label class="form-label">날짜</label>
              <div class="input-group input-group-sm">
                <input type="date" id="dateStartSide" class="form-control" th:value="${param.dateStart}">
                <span class="input-group-text">~</span>
                <input type="date" id="dateEndSide" class="form-control" th:value="${param.dateEnd}">
              </div>
            </div>

            <!-- 활동 유형 -->
            <div class="mb-3">
              <label class="form-label d-block">활동 유형</label>
              <select id="activityTypeSide" class="form-select form-select-sm">
                <option value="" th:selected="${param.activityType} == null or ${param.activityType} == ''">전체</option>
                <option value="육상" th:selected="${param.activityType} == '육상'">육상</option>
                <option value="수상" th:selected="${param.activityType} == '수상'">수상</option>
                <option value="공중" th:selected="${param.activityType} == '공중'">공중</option>
                <!-- 동적 옵션 추가 -->
                <option th:if="${param.activityType != null and param.activityType != '' and 
                    !(param.activityType == '육상' or param.activityType == '수상' or param.activityType == '공중')}"
                        th:value="${param.activityType}"
                        th:text="${param.activityType}"
                        selected>
                </option>
              </select>
            </div>

            <!-- 인원 수 -->
            <div class="mb-3">
              <label class="form-label d-block">인원</label>
              <input type="number" id="peopleCountSide" class="form-control form-control-sm" min="1" th:value="${param.peopleCount}">
            </div>

            <div class="d-grid">
              <button class="btn btn-primary btn-sm"
                onclick="(function(e){
                  e.preventDefault();
                  var r=document.getElementById('regionSelectSide')?.value||'';
                  var ds=document.getElementById('dateStartSide')?.value||'';
                  var de=document.getElementById('dateEndSide')?.value||'';
                  var ty=document.getElementById('activityTypeSide')?.value||'';
                  var pc=document.getElementById('peopleCountSide')?.value||'';
                  var params=[];
                  if(r) params.push('region='+encodeURIComponent(r));
                  if(ds) params.push('dateStart='+encodeURIComponent(ds));
                  if(de) params.push('dateEnd='+encodeURIComponent(de));
                  if(ty) params.push('activityType='+encodeURIComponent(ty));
                  if(pc) params.push('peopleCount='+encodeURIComponent(pc));
                  var url='/fragments/reservation'+(params.length?('?'+params.join('&')):'');
                  loadPage(e, url);
                })(event)">검색</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 중앙 리스트 영역 -->
      <div class="col-xl-6 col-lg-7 px-3">
        <section class="bg-light rounded-4 shadow-sm px-4 py-4"
          style="height: calc(100vh - 100px); display: flex; flex-direction: column; margin-top: 50px;">

          <!-- 헤더 -->
          <div style="flex: 0 0 auto; position: sticky; top: 0; background: #ffffff; padding-top: 10px; padding-bottom: 10px; z-index: 10; border-bottom: 1px solid #dee2e6;">
            <h4 class="fw-bold mb-0">예약 가능한 활동</h4>
          </div>

          <!-- 예약 리스트 -->
          <div style="flex: 1 1 auto; overflow-y: auto; margin-top: 10px;">
            <div class="row g-3">
              <!-- DB 활동 리스트 -->
              <div class="col-12" th:if="${#lists.isEmpty(activities)}">
                <div class="text-muted text-center py-5">표시할 활동이 없습니다.</div>
              </div>
              <div class="col-12" th:each="act : ${activities}">
                <div class="card border-0 shadow-sm rounded-3 p-2" style="background-color: #ffffff;">
                  <div class="row g-0 align-items-center">
                    <div class="col-auto">
                      <img src="/img/climb_1.jpg" alt="활동 썸네일" class="rounded-2" style="width: 80px; height: 80px; object-fit: cover;">
                    </div>
                    <div class="col px-3">
                      <h6 class="mb-1 fw-semibold" th:text="${act.title}">활동 제목</h6>
                      <div class="small text-muted d-flex flex-wrap gap-3">
                        <span><strong>위치:</strong> <span th:text="${act.location}">위치</span></span>
                        <span><strong>날짜:</strong> <span th:text="${act.activityDate}">2025-08-01</span></span>
                      </div>
                      <div class="small text-muted d-flex flex-wrap gap-3 mt-1">
                        <span><strong>정원:</strong> <span th:text="${act.maxParticipants}">0</span>명</span>
                        <span><strong>참여:</strong> <span th:text="${act.currentParticipants}">0</span>명</span>
                      </div>
                    </div>
                    <div class="col-auto px-2">
                      <button class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal" data-bs-target="#reservationModal"
                        th:attr="
                          data-activity-id=${act.id},
                          data-title=${act.title},
                          data-location=${act.location},
                          data-date=${act.activityDate},
                          data-start=${act.startTime},
                          data-end=${act.endTime},
                          data-max=${act.maxParticipants},
                          data-current=${act.currentParticipants}">
                        예약
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>
      </div>

      <!-- 우측 여백 -->
      <div class="col-xl-3 d-none d-xl-block"></div>

      <!-- 예약 모달 (분리된 프래그먼트 포함) -->
      <div th:replace="~{fragments/reservation-modal :: reservationModal}"></div>

    </div>
  </div>
</div>
<style>
  .list-group-item:hover { background-color: #eef4ff !important; }
  .form-select-sm, .input-group-sm > .form-control { font-size: .9rem; }
</style>
