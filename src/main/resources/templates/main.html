<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Hanhang Activity</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/company-dashboard.js"></script>
    <style>
    </style>
</head>
<body>
    <!-- 상단 고정 내비게이션 -->
    <div th:replace="~{fragments/header :: navbar}"></div>

    <!-- 비동기로 교체될 콘텐츠 영역 -->
    <div id="content" class="container-main"></div>
</body>
<script>
    function loadPage(eventOrNull, url) {
        if (eventOrNull && typeof eventOrNull.preventDefault === 'function') {
            eventOrNull.preventDefault();
        }

        const AUTH_REQUIRED_ERROR = 'AUTH_REQUIRED';
        const AUTH_FORBIDDEN_ERROR = 'AUTH_FORBIDDEN';

        fetch(url, { credentials: 'same-origin' })
            .then(res => {
                if (res.status === 401) {
                    alert('로그인이 필요합니다.');
                    if (url !== '/fragments/company-login') {
                        loadPage(null, '/fragments/company-login');
                    }
                    throw new Error(AUTH_REQUIRED_ERROR);
                }
                if (res.status === 403) {
                    return res.text().then(body => {
                        alert(body || '접근 권한이 없습니다.');
                        throw new Error(AUTH_FORBIDDEN_ERROR);
                    });
                }
                if (!res.ok) {
                    throw new Error('페이지를 불러오는데 실패했습니다.');
                }
                return res.text();
            })
            .then(html => {
                if (typeof html !== 'string') {
                    return;
                }
                const contentDiv = document.getElementById('content');
                if (contentDiv) {
                    contentDiv.innerHTML = html;
                    executeInlineScripts(contentDiv);
                    if (typeof window.initializeCompanyDashboard === 'function') {
                        window.initializeCompanyDashboard(contentDiv);
                    }
                } else {
                    console.error('id="content" 요소가 없습니다.');
                }
            })
            .catch(err => {
                if (err?.message === AUTH_REQUIRED_ERROR || err?.message === AUTH_FORBIDDEN_ERROR) {
                    return;
                }
            });
    }

    function executeInlineScripts(container) {
        if (!container) return;

        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            for (const attr of oldScript.attributes) {
                newScript.setAttribute(attr.name, attr.value);
            }
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPage(null, '/fragments/home');
    });

    // 예약 모달에 활동 정보 채우기
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('[data-bs-target="#reservationModal"][data-activity-id]');
        if (!btn) return;

        const modalEl = document.getElementById('reservationModal');
        if (!modalEl) return;

        const title = btn.getAttribute('data-title') || '';
        const location = btn.getAttribute('data-location') || '';
        const date = btn.getAttribute('data-date') || '';
        const start = btn.getAttribute('data-start') || '';
        const end = btn.getAttribute('data-end') || '';
        const activityId = btn.getAttribute('data-activity-id') || '';
        const max = parseInt(btn.getAttribute('data-max') || '0', 10);
        const current = parseInt(btn.getAttribute('data-current') || '0', 10);
        const left = Math.max(0, (isNaN(max) ? 0 : max) - (isNaN(current) ? 0 : current));
        const timeText = (start || end) ? ` (${start || ''}${end ? ' ~ ' + end : ''})` : '';

        const setText = (sel, val) => {
            const targets = modalEl.querySelectorAll(sel);
            targets.forEach(el => { el.textContent = val; });
        };
        setText('[data-field="title"]', title);
        setText('[data-field="location"]', location);
        setText('[data-field="date"]', date);
        setText('[data-field="time"]', timeText);
        setText('[data-field="left"]', String(left));

        const form = modalEl.querySelector('#reservationForm');
        if (form) {
            form.reset();
            const errorBox = form.querySelector('[data-role="reservation-error"]');
            const successBox = form.querySelector('[data-role="reservation-success"]');
            if (errorBox) { errorBox.classList.add('d-none'); errorBox.textContent = ''; }
            if (successBox) { successBox.classList.add('d-none'); successBox.textContent = ''; }
        }

        const hiddenId = modalEl.querySelector('#activityId');
        if (hiddenId) hiddenId.value = activityId;

        const availableInput = modalEl.querySelector('#availableSeats');
        if (availableInput) availableInput.value = String(left);

        const peopleInput = modalEl.querySelector('#peopleCount');
        if (peopleInput) {
            peopleInput.max = String(Math.max(1, left));
            if (left <= 0) {
                peopleInput.value = '0';
                peopleInput.disabled = true;
            } else {
                peopleInput.disabled = false;
                peopleInput.value = '1';
            }
        }
    });

    // 예약 인원 +/- 버튼
    document.addEventListener('click', function (e) {
        const minusBtn = e.target.closest('#btnPeopleMinus');
        const plusBtn = e.target.closest('#btnPeoplePlus');
        if (!minusBtn && !plusBtn) return;
        const wrap = e.target.closest('.modal') || document;
        const input = wrap.querySelector('#peopleCount');
        if (!input || input.disabled) return;
        const max = parseInt(input.max || '9999', 10);
        const min = parseInt(input.min || '1', 10);
        let val = parseInt(input.value || String(min), 10);
        if (Number.isNaN(val)) val = min;
        if (minusBtn) val = Math.max(min, val - 1);
        if (plusBtn) val = Math.min(max, val + 1);
        input.value = String(val);
    });

    document.addEventListener('submit', async function (e) {
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (form.id !== 'reservationForm') return;
        e.preventDefault();

        const modalEl = document.getElementById('reservationModal');
        const submitBtn = modalEl?.querySelector('button[type="submit"]');
        const errorBox = form.querySelector('[data-role="reservation-error"]');
        const successBox = form.querySelector('[data-role="reservation-success"]');
        if (errorBox) { errorBox.classList.add('d-none'); errorBox.textContent = ''; }
        if (successBox) { successBox.classList.add('d-none'); successBox.textContent = ''; }

        const activityId = form.querySelector('#activityId')?.value?.trim();
        const name = form.querySelector('#name')?.value?.trim();
        const passport = form.querySelector('#passport')?.value?.trim();
        const nationality = form.querySelector('#nationality')?.value?.trim();
        const birthdate = form.querySelector('#birthdate')?.value?.trim();
        const gender = form.querySelector('#gender')?.value?.trim();
        const email = form.querySelector('#email')?.value?.trim();
        const specialRequest = form.querySelector('#specialRequest')?.value?.trim();
        const availableSeats = parseInt(form.querySelector('#availableSeats')?.value || '0', 10);
        const peopleCount = parseInt(form.querySelector('#peopleCount')?.value || '1', 10);

        const showError = (message) => {
            if (errorBox) {
                errorBox.textContent = message || '예약 요청 처리 중 오류가 발생했습니다.';
                errorBox.classList.remove('d-none');
            } else {
                alert(message);
            }
        };

        if (!activityId) {
            showError('선택된 활동 정보가 없습니다.');
            return;
        }
        if (!name || !passport || !nationality || !birthdate || !email) {
            showError('필수 정보를 모두 입력해 주세요.');
            return;
        }
        if (peopleCount <= 0) {
            showError('예약 인원은 1명 이상이어야 합니다.');
            return;
        }
        if (availableSeats <= 0) {
            showError('현재 예약 가능한 좌석이 없습니다.');
            return;
        }
        if (availableSeats > 0 && peopleCount > availableSeats) {
            showError(`잔여 좌석이 부족합니다. (가능 인원 ${availableSeats}명)`);
            return;
        }

        const payload = {
            activityId: Number(activityId),
            touristName: name,
            passportNumber: passport,
            nationality,
            birthdate,
            gender,
            email,
            peopleCount,
            specialRequest
        };

        let originalBtnHtml;
        if (submitBtn instanceof HTMLButtonElement) {
            originalBtnHtml = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        }

        try {
            const response = await fetch('/api/public/reservations', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const rawBody = await response.text();
            if (!response.ok) {
                let message = rawBody;
                try {
                    const json = JSON.parse(rawBody);
                    message = json?.message || json?.detail || message;
                } catch (_) {
                    // ignore json parse failure
                }
                throw new Error(message || `예약 요청이 실패했습니다. (HTTP ${response.status})`);
            }

            if (successBox) {
                successBox.textContent = '예약 요청이 접수되었습니다. 운영자가 확인 후 안내드릴 예정입니다.';
                successBox.classList.remove('d-none');
            }

            if (modalEl) {
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                setTimeout(() => modal.hide(), 1200);
            }
        } catch (err) {
            showError(err instanceof Error ? err.message : String(err));
        } finally {
            if (submitBtn instanceof HTMLButtonElement) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHtml || '예약 완료';
            }
        }
    });
</script>
</html>
