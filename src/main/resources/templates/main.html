<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Hanhang Activity</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <style>
    </style>
</head>

<body>
    <!-- 상단 고정 내비게이션 -->
    <div th:replace="~{fragments/header :: navbar}"></div>

    <!-- 비동기로 교체될 콘텐츠 영역 -->
    <div id="content" class="container-main"></div>
</body>
<script>
    function loadPage(eventOrNull, url) {
        if (eventOrNull && typeof eventOrNull.preventDefault === 'function') {
            eventOrNull.preventDefault();
        }

        const AUTH_REQUIRED_ERROR = 'AUTH_REQUIRED';
        const AUTH_FORBIDDEN_ERROR = 'AUTH_FORBIDDEN';

        fetch(url, { credentials: 'same-origin' })
            .then(res => {
                if (res.status === 401) {
                    alert('로그인이 필요합니다.');
                    if (url !== '/fragments/company-login') {
                        loadPage(null, '/fragments/company-login');
                    }
                    throw new Error(AUTH_REQUIRED_ERROR);
                }
                if (res.status === 403) {
                    return res.text().then(body => {
                        alert(body || '접근 권한이 없습니다.');
                        throw new Error(AUTH_FORBIDDEN_ERROR);
                    });
                }
                if (!res.ok) {
                    throw new Error('페이지를 불러오는 데 실패했습니다.');
                }
                return res.text();
            })
            .then(html => {
                if (typeof html !== 'string') {
                    return;
                }
                const contentDiv = document.getElementById('content');
                if (contentDiv) {
                    contentDiv.innerHTML = html;
                    executeInlineScripts(contentDiv);
                } else {
                    console.error('id="content" 요소가 없습니다.');
                }
            })
            .catch(err => {
                if (err?.message === AUTH_REQUIRED_ERROR || err?.message === AUTH_FORBIDDEN_ERROR) {
                    return;
                }
            });
    }

    function executeInlineScripts(container) {
        if (!container) return;
        
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            for (const attr of oldScript.attributes) {
                newScript.setAttribute(attr.name, attr.value);
            }
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPage(null, '/fragments/home');
    });

    // 비동기 콘텐츠용 모달 선택 시 활동 정보 채우기
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('[data-bs-target="#reservationModal"][data-activity-id]');
        if (!btn) return;

        const modalEl = document.getElementById('reservationModal');
        if (!modalEl) return;

        const title = btn.getAttribute('data-title') || '';
        const location = btn.getAttribute('data-location') || '';
        const date = btn.getAttribute('data-date') || '';
        const start = btn.getAttribute('data-start') || '';
        const end = btn.getAttribute('data-end') || '';
        const activityId = btn.getAttribute('data-activity-id') || '';
        const max = parseInt(btn.getAttribute('data-max') || '0', 10);
        const current = parseInt(btn.getAttribute('data-current') || '0', 10);
        const left = Math.max(0, (isNaN(max) ? 0 : max) - (isNaN(current) ? 0 : current));
        const timeText = (start || end) ? ` (${start || ''}${end ? ' ~ ' + end : ''})` : '';

        const setText = (sel, val) => { const el = modalEl.querySelector(sel); if (el) el.textContent = val; };
        setText('[data-field="title"]', title);
        setText('[data-field="location"]', location);
        setText('[data-field="date"]', date);
        setText('[data-field="time"]', timeText);
        setText('[data-field="max"]', isNaN(max) ? '-' : String(max));
        setText('[data-field="current"]', isNaN(current) ? '-' : String(current));
        setText('[data-field="left"]', String(left));

        const hiddenId = modalEl.querySelector('#activityId');
        if (hiddenId) hiddenId.value = activityId;

        const peopleInput = modalEl.querySelector('#peopleCount');
        if (peopleInput) {
            peopleInput.max = String(Math.max(1, left));
            if (left <= 0) {
                peopleInput.value = '0';
                peopleInput.disabled = true;
            } else {
                peopleInput.disabled = false;
                peopleInput.value = '1';
            }
        }
    });

    // 인증코드 전송 (임시 처리)
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('#sendCodeBtn');
        if (!btn) return;
        const wrap = btn.closest('.modal') || document;
        const emailInput = wrap.querySelector('#email');
        const email = emailInput ? emailInput.value : '';
        if (!email) return alert('이메일을 입력해 주세요.');
        alert('인증코드를 이메일로 보냈습니다.');
    });

    // 예약 제출 (임시 처리)
    // 참가 인원 +/- 버튼 동작
    document.addEventListener('click', function (e) {
        const minusBtn = e.target.closest('#btnPeopleMinus');
        const plusBtn = e.target.closest('#btnPeoplePlus');
        if (!minusBtn && !plusBtn) return;
        const wrap = e.target.closest('.modal') || document;
        const input = wrap.querySelector('#peopleCount');
        if (!input) return;
        if (input.disabled) return;
        const max = parseInt(input.max || '9999', 10);
        const min = parseInt(input.min || '1', 10);
        let val = parseInt(input.value || String(min), 10);
        if (Number.isNaN(val)) val = min;
        if (minusBtn) val = Math.max(min, val - 1);
        if (plusBtn) val = Math.min(max, val + 1);
        input.value = String(val);
    });

    document.addEventListener('submit', function (e) {
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (form.id !== 'reservationForm') return;
        e.preventDefault();

        const modalEl = document.getElementById('reservationModal');
        const name = form.querySelector('#name')?.value;
        const passport = form.querySelector('#passport')?.value;
        const email = form.querySelector('#email')?.value;
        const emailCode = form.querySelector('#emailCode')?.value;
        const activityId = form.querySelector('#activityId')?.value;
        const peopleCount = parseInt(form.querySelector('#peopleCount')?.value || '1', 10);

        console.log({ activityId, name, passport, email, emailCode, peopleCount });
        alert('예약이 완료되었습니다.');
        if (modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
        }
    });
</script>

</html>